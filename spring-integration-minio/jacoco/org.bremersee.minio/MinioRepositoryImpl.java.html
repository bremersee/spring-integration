<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MinioRepositoryImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Spring Integration Minio</a> &gt; <a href="index.source.html" class="el_package">org.bremersee.minio</a> &gt; <span class="el_source">MinioRepositoryImpl.java</span></div><h1>MinioRepositoryImpl.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2020 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.bremersee.minio;

import io.minio.BucketExistsArgs;
import io.minio.GetBucketVersioningArgs;
import io.minio.GetPresignedObjectUrlArgs;
import io.minio.ListObjectsArgs;
import io.minio.MakeBucketArgs;
import io.minio.MinioClient;
import io.minio.ObjectWriteResponse;
import io.minio.PutObjectArgs;
import io.minio.RemoveObjectArgs;
import io.minio.RemoveObjectsArgs;
import io.minio.Result;
import io.minio.SetBucketVersioningArgs;
import io.minio.StatObjectArgs;
import io.minio.StatObjectResponse;
import io.minio.http.Method;
import io.minio.messages.DeleteError;
import io.minio.messages.DeleteObject;
import io.minio.messages.Item;
import io.minio.messages.VersioningConfiguration;
import io.minio.messages.VersioningConfiguration.Status;
import java.io.IOException;
import java.io.InputStream;
import java.nio.file.Files;
import java.time.Duration;
import java.time.temporal.ChronoUnit;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;
import lombok.Getter;
import org.bremersee.exception.ServiceException;
import org.springframework.http.MediaType;
import org.springframework.util.StringUtils;
import org.springframework.web.multipart.MultipartFile;

/**
 * The minio repository implementation.
 *
 * @author Christian Bremer
 */
public class MinioRepositoryImpl implements MinioRepository {

  private final MinioOperations minio;

  /**
   * The region.
   */
  @Getter
  private final String region;

  /**
   * The bucket.
   */
  @Getter
  private final String bucket;

  private final boolean enableVersioning;

  private final Duration presignedObjectUrlDuration;

  /**
   * Instantiates a new minio repository.
   *
   * @param minioOperations the minio operations
   * @param region the region
   * @param bucket the bucket
   * @param enableVersioning the enable versioning
   * @param create the create
   * @param presignedObjectUrlDuration the presigned object url duration
   */
  public MinioRepositoryImpl(
      MinioOperations minioOperations,
      String region,
      String bucket,
      boolean enableVersioning,
      boolean create,
<span class="fc" id="L97">      Duration presignedObjectUrlDuration) {</span>

<span class="fc" id="L99">    this.minio = minioOperations;</span>
<span class="fc" id="L100">    this.region = region;</span>
<span class="fc" id="L101">    this.bucket = bucket;</span>
<span class="fc" id="L102">    this.enableVersioning = enableVersioning;</span>
<span class="fc" id="L103">    this.presignedObjectUrlDuration = validateDuration(presignedObjectUrlDuration);</span>
<span class="fc bfc" id="L104" title="All 2 branches covered.">    if (create) {</span>
<span class="fc" id="L105">      createBucket();</span>
    }
<span class="fc" id="L107">  }</span>

  /**
   * Instantiates a new minio repository.
   *
   * @param minioClient the minio client
   * @param region the region
   * @param bucket the bucket
   * @param enableVersioning the enable versioning
   * @param create the create
   * @param presignedObjectUrlDuration the presigned object url duration
   */
  public MinioRepositoryImpl(
      MinioClient minioClient,
      String region,
      String bucket,
      boolean enableVersioning,
      boolean create,
      Duration presignedObjectUrlDuration) {

<span class="fc" id="L127">    this(</span>
        new MinioTemplate(minioClient),
        region,
        bucket,
        enableVersioning,
        create,
        presignedObjectUrlDuration);
<span class="fc" id="L134">  }</span>

  private static Duration validateDuration(Duration presignedObjectUrlDuration) {
<span class="fc" id="L137">    return Optional.ofNullable(presignedObjectUrlDuration)</span>
<span class="pc bpc" id="L138" title="1 of 2 branches missed.">        .filter(duration -&gt; duration.toMillis() &gt; 1000L * 30L</span>
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">            &amp;&amp; duration.toMillis() &lt; 1000L * 60L * 60L * 24L * 7L)</span>
<span class="pc" id="L140">        .orElseGet(() -&gt; Duration.of(1L, ChronoUnit.DAYS));</span>
  }

  private void createBucket() {
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">    if (!minio.bucketExists(BucketExistsArgs.builder().bucket(bucket).build())) {</span>
<span class="fc" id="L145">      minio.makeBucket(MakeBucketArgs.builder()</span>
<span class="fc" id="L146">          .region(region)</span>
<span class="fc" id="L147">          .bucket(bucket)</span>
<span class="fc" id="L148">          .build());</span>
    }
<span class="fc" id="L150">    VersioningConfiguration versioningConfiguration = minio.getBucketVersioning(</span>
<span class="fc" id="L151">        GetBucketVersioningArgs.builder()</span>
<span class="fc" id="L152">            .region(region)</span>
<span class="fc" id="L153">            .bucket(bucket)</span>
<span class="fc" id="L154">            .build());</span>
<span class="pc bpc" id="L155" title="2 of 3 branches missed.">    switch (versioningConfiguration.status()) {</span>
      case ENABLED:
<span class="nc bnc" id="L157" title="All 2 branches missed.">        if (!enableVersioning) {</span>
<span class="nc" id="L158">          minio.setBucketVersioning(SetBucketVersioningArgs.builder()</span>
<span class="nc" id="L159">              .region(region)</span>
<span class="nc" id="L160">              .bucket(bucket)</span>
<span class="nc" id="L161">              .config(new VersioningConfiguration(Status.SUSPENDED, false))</span>
<span class="nc" id="L162">              .build());</span>
        }
        break;
      case SUSPENDED:
      case OFF:
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">        if (enableVersioning) {</span>
<span class="fc" id="L168">          minio.setBucketVersioning(SetBucketVersioningArgs.builder()</span>
<span class="fc" id="L169">              .region(region)</span>
<span class="fc" id="L170">              .bucket(bucket)</span>
<span class="fc" id="L171">              .config(new VersioningConfiguration(Status.ENABLED, false))</span>
<span class="fc" id="L172">              .build());</span>
        }
        break;
      default:
    }
<span class="fc" id="L177">  }</span>

  @Override
  public MinioOperations getMinioOperations() {
<span class="fc" id="L181">    return minio;</span>
  }

  @Override
  public boolean isVersioningEnabled() {
<span class="fc" id="L186">    return enableVersioning;</span>
  }

  @Override
  public Optional&lt;ObjectWriteResponse&gt; save(
      MinioObjectId id,
      MultipartFile multipartFile,
      DeleteMode deleteMode) {

<span class="fc" id="L195">    return Optional.ofNullable(multipartFile)</span>
<span class="fc bfc" id="L196" title="All 2 branches covered.">        .filter(file -&gt; !file.isEmpty())</span>
<span class="fc" id="L197">        .map(file -&gt; {</span>
<span class="fc" id="L198">          try (InputStream in = file.getInputStream()) {</span>
<span class="fc" id="L199">            ObjectWriteResponse response = minio.putObject(PutObjectArgs.builder()</span>
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">                .contentType(StringUtils.hasText(file.getContentType())</span>
<span class="fc" id="L201">                    ? file.getContentType()</span>
<span class="nc" id="L202">                    : MediaType.APPLICATION_OCTET_STREAM_VALUE)</span>
<span class="fc" id="L203">                .stream(in, file.getSize(), -1)</span>
<span class="fc" id="L204">                .region(region)</span>
<span class="fc" id="L205">                .bucket(bucket)</span>
<span class="fc" id="L206">                .object(id.getName())</span>
<span class="fc" id="L207">                .build());</span>
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">            if (DeleteMode.ON_SUCCESS == deleteMode) {</span>
<span class="nc" id="L209">              delete(file);</span>
            }
<span class="fc" id="L211">            return response;</span>

<span class="nc" id="L213">          } catch (IOException e) {</span>
<span class="nc" id="L214">            throw ServiceException.internalServerError(&quot;Put object failed.&quot;, e);</span>

          } finally {
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">            if (DeleteMode.ALWAYS == deleteMode) {</span>
<span class="fc" id="L218">              delete(file);</span>
            }
          }
        });
  }

  private static void delete(MultipartFile multipartFile) {
<span class="pc bpc" id="L225" title="2 of 4 branches missed.">    if (multipartFile != null &amp;&amp; multipartFile.getResource().isFile()) {</span>
      try {
<span class="fc" id="L227">        Files.delete(multipartFile.getResource().getFile().toPath());</span>
<span class="nc" id="L228">      } catch (Exception ignored) {</span>
        // ignored
<span class="fc" id="L230">      }</span>
    }
<span class="fc" id="L232">  }</span>

  @Override
  public boolean exists(MinioObjectId id) {
<span class="fc" id="L236">    return minio.objectExists(StatObjectArgs.builder()</span>
<span class="fc" id="L237">        .region(region)</span>
<span class="fc" id="L238">        .bucket(bucket)</span>
<span class="fc" id="L239">        .object(id.getName())</span>
<span class="fc" id="L240">        .versionId(id.getVersionId())</span>
<span class="fc" id="L241">        .build());</span>
  }

  @Override
  public Optional&lt;MinioMultipartFile&gt; findOne(MinioObjectId id) {
    try {
<span class="fc" id="L247">      StatObjectResponse objectStat = minio.statObject(StatObjectArgs.builder()</span>
<span class="fc" id="L248">          .region(region)</span>
<span class="fc" id="L249">          .bucket(bucket)</span>
<span class="fc" id="L250">          .object(id.getName())</span>
<span class="fc" id="L251">          .versionId(id.getVersionId())</span>
<span class="fc" id="L252">          .build());</span>
<span class="fc" id="L253">      return Optional.of(new MinioMultipartFileImpl(minio, region, objectStat));</span>

<span class="nc" id="L255">    } catch (MinioException e) {</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">      if (404 == e.status()) {</span>
<span class="nc" id="L257">        return Optional.empty();</span>
      }
<span class="nc" id="L259">      throw e;</span>
    }
  }

  @Override
  public List&lt;MinioMultipartFile&gt; findAll(String prefix) {
<span class="fc" id="L265">    Iterable&lt;Result&lt;Item&gt;&gt; results = minio.listObjects(ListObjectsArgs.builder()</span>
<span class="fc" id="L266">        .region(region)</span>
<span class="fc" id="L267">        .bucket(bucket)</span>
<span class="fc" id="L268">        .includeVersions(enableVersioning)</span>
<span class="fc" id="L269">        .recursive(true)</span>
<span class="fc" id="L270">        .prefix(prefix)</span>
<span class="fc" id="L271">        .build());</span>
<span class="fc" id="L272">    List&lt;MinioMultipartFile&gt; fileList = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L273" title="All 2 branches covered.">    for (Result&lt;Item&gt; result : results) {</span>
      try {
<span class="fc" id="L275">        Item item = result.get();</span>
<span class="pc bpc" id="L276" title="2 of 4 branches missed.">        if (!item.isDir() &amp;&amp; !item.isDeleteMarker()) {</span>
<span class="fc" id="L277">          fileList.add(new MinioMultipartFileImpl(</span>
<span class="fc" id="L278">              getMinioOperations(),</span>
              region,
              bucket,
              item));
        }
<span class="nc" id="L283">      } catch (Exception ignored) {</span>
        // ignored
<span class="fc" id="L285">      }</span>
<span class="fc" id="L286">    }</span>
<span class="fc" id="L287">    return fileList;</span>
  }

  @Override
  public void delete(MinioObjectId id) {
<span class="fc" id="L292">    minio.removeObject(RemoveObjectArgs.builder()</span>
<span class="fc" id="L293">        .region(region)</span>
<span class="fc" id="L294">        .bucket(bucket)</span>
<span class="fc" id="L295">        .object(id.getName())</span>
<span class="fc" id="L296">        .versionId(id.getVersionId())</span>
<span class="fc" id="L297">        .build());</span>
<span class="fc" id="L298">  }</span>

  @Override
  public List&lt;DeleteError&gt; deleteAll(Collection&lt;MinioObjectId&gt; ids) {

<span class="pc bpc" id="L303" title="2 of 4 branches missed.">    if (ids == null || ids.isEmpty()) {</span>
<span class="nc" id="L304">      return Collections.emptyList();</span>
    }
<span class="fc" id="L306">    Iterable&lt;Result&lt;DeleteError&gt;&gt; errors = minio.removeObjects(RemoveObjectsArgs.builder()</span>
<span class="fc" id="L307">        .region(region)</span>
<span class="fc" id="L308">        .bucket(bucket)</span>
<span class="fc" id="L309">        .objects(ids.stream()</span>
<span class="fc" id="L310">            .map(id -&gt; new DeleteObject(id.getName(), id.getVersionId()))</span>
<span class="fc" id="L311">            .collect(Collectors.toSet()))</span>
<span class="fc" id="L312">        .build());</span>
<span class="fc" id="L313">    List&lt;DeleteError&gt; errorList = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L314" title="All 2 branches covered.">    for (Result&lt;DeleteError&gt; error : errors) {</span>
      try {
<span class="fc" id="L316">        errorList.add(error.get());</span>
<span class="nc" id="L317">      } catch (Exception ignored) {</span>
        // ignored
<span class="fc" id="L319">      }</span>
<span class="fc" id="L320">    }</span>
<span class="fc" id="L321">    return errorList;</span>
  }

  @Override
  public String getPresignedObjectUrl(MinioObjectId id, Method method, Duration duration) {
<span class="pc bpc" id="L326" title="1 of 2 branches missed.">    Duration expiry = duration != null ? validateDuration(duration) : presignedObjectUrlDuration;</span>
<span class="fc" id="L327">    return minio.getPresignedObjectUrl(GetPresignedObjectUrlArgs.builder()</span>
<span class="fc" id="L328">        .expiry((int) expiry.toSeconds())</span>
<span class="fc" id="L329">        .method(method)</span>
<span class="fc" id="L330">        .region(region)</span>
<span class="fc" id="L331">        .bucket(bucket)</span>
<span class="fc" id="L332">        .object(id.getName())</span>
<span class="fc" id="L333">        .versionId(id.getVersionId())</span>
<span class="fc" id="L334">        .build());</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>