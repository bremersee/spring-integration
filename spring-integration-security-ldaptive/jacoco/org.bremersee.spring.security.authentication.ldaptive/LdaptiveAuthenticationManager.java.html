<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LdaptiveAuthenticationManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Spring Integration Security Ldaptive</a> &gt; <a href="index.source.html" class="el_package">org.bremersee.spring.security.authentication.ldaptive</a> &gt; <span class="el_source">LdaptiveAuthenticationManager.java</span></div><h1>LdaptiveAuthenticationManager.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2014 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.bremersee.spring.security.authentication.ldaptive;

import static java.util.Objects.isNull;
import static java.util.Objects.nonNull;

import java.util.Objects;
import java.util.Optional;
import lombok.AccessLevel;
import lombok.Getter;
import lombok.Setter;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.bremersee.ldaptive.LdaptiveException;
import org.bremersee.ldaptive.LdaptiveTemplate;
import org.bremersee.spring.security.authentication.EmailToUsernameResolver;
import org.bremersee.spring.security.authentication.ldaptive.provider.NoAccountControlEvaluator;
import org.bremersee.spring.security.core.userdetails.ldaptive.LdaptiveRememberMeTokenProvider;
import org.bremersee.spring.security.core.userdetails.ldaptive.LdaptiveUserDetails;
import org.bremersee.spring.security.core.userdetails.ldaptive.LdaptiveUserDetailsService;
import org.ldaptive.BindConnectionInitializer;
import org.ldaptive.CompareRequest;
import org.ldaptive.ConnectionConfig;
import org.ldaptive.ConnectionFactory;
import org.ldaptive.DefaultConnectionFactory;
import org.ldaptive.LdapException;
import org.ldaptive.ResultCode;
import org.springframework.core.convert.converter.Converter;
import org.springframework.security.authentication.AccountExpiredException;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.AuthenticationProvider;
import org.springframework.security.authentication.BadCredentialsException;
import org.springframework.security.authentication.CredentialsExpiredException;
import org.springframework.security.authentication.DisabledException;
import org.springframework.security.authentication.LockedException;
import org.springframework.security.authentication.RememberMeAuthenticationToken;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.core.authority.mapping.GrantedAuthoritiesMapper;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.util.Assert;

/**
 * The ldaptive authentication manager.
 *
 * @author Christian Bremer
 */
public class LdaptiveAuthenticationManager
    implements AuthenticationManager, AuthenticationProvider { // message source aware

  /**
   * The Logger.
   */
<span class="fc" id="L70">  protected final Log logger = LogFactory.getLog(this.getClass());</span>

  /**
   * The authentication properties.
   */
  @Getter(AccessLevel.PROTECTED)
  private final LdaptiveAuthenticationProperties authenticationProperties;

  /**
   * The application ldaptive template.
   */
  @Getter(AccessLevel.PROTECTED)
  private final LdaptiveTemplate applicationLdaptiveTemplate;

  /**
   * The email to username resolver.
   */
  @Getter(AccessLevel.PROTECTED)
  private EmailToUsernameResolver emailToUsernameResolver;

  /**
   * The username to bind-dn converter.
   */
  @Getter(AccessLevel.PROTECTED)
  private UsernameToBindDnConverter usernameToBindDnConverter;

  /**
   * The password encoder.
   */
  @Getter(AccessLevel.PROTECTED)
  @Setter
  private PasswordEncoder passwordEncoder;

  /**
   * The account control evaluator.
   */
  @Getter(AccessLevel.PROTECTED)
  private AccountControlEvaluator accountControlEvaluator;

  /**
   * The granted authorities mapper.
   */
  @Getter(AccessLevel.PROTECTED)
  @Setter
  private GrantedAuthoritiesMapper grantedAuthoritiesMapper;

  /**
   * The remember-me token provider.
   */
  @Getter(AccessLevel.PROTECTED)
  @Setter
  private LdaptiveRememberMeTokenProvider passwordProvider;

  /**
   * The token converter.
   */
  @Getter(AccessLevel.PROTECTED)
  @Setter
  private Converter&lt;LdaptiveUserDetails, LdaptiveAuthentication&gt; tokenConverter;

  /**
   * Instantiates a new ldaptive authentication manager.
   *
   * @param connectionConfig the connection config
   * @param authenticationProperties the authentication properties
   */
  public LdaptiveAuthenticationManager(
      ConnectionConfig connectionConfig,
      LdaptiveAuthenticationProperties authenticationProperties) {
<span class="fc" id="L139">    this(new DefaultConnectionFactory(connectionConfig), authenticationProperties);</span>
<span class="fc" id="L140">  }</span>

  /**
   * Instantiates a new ldaptive authentication manager.
   *
   * @param connectionFactory the connection factory
   * @param authenticationProperties the authentication properties
   */
  public LdaptiveAuthenticationManager(
      ConnectionFactory connectionFactory,
      LdaptiveAuthenticationProperties authenticationProperties) {
<span class="fc" id="L151">    this(new LdaptiveTemplate(connectionFactory), authenticationProperties);</span>
<span class="fc" id="L152">  }</span>

  /**
   * Instantiates a new ldaptive authentication manager.
   *
   * @param applicationLdaptiveTemplate the application ldaptive template
   * @param authenticationProperties the authentication properties
   */
  public LdaptiveAuthenticationManager(
      LdaptiveTemplate applicationLdaptiveTemplate,
<span class="fc" id="L162">      LdaptiveAuthenticationProperties authenticationProperties) {</span>

<span class="fc" id="L164">    this.applicationLdaptiveTemplate = applicationLdaptiveTemplate;</span>
<span class="fc" id="L165">    Assert.notNull(getApplicationLdaptiveTemplate(), &quot;Application ldaptive template is required.&quot;);</span>
<span class="fc" id="L166">    this.authenticationProperties = authenticationProperties;</span>
<span class="fc" id="L167">    Assert.notNull(getAuthenticationProperties(), &quot;Authentication properties are required.&quot;);</span>

    // emailToUsernameResolver
<span class="fc" id="L170">    setEmailToUsernameResolver(new EmailToUsernameResolverByLdapAttribute(</span>
<span class="fc" id="L171">        getAuthenticationProperties(), getApplicationLdaptiveTemplate()));</span>

    // usernameToBindDnConverter
<span class="fc" id="L174">    Assert.notNull(getAuthenticationProperties().getUsernameToBindDnConverter(),</span>
        &quot;Username to bind dn converter is required.&quot;);
<span class="fc" id="L176">    setUsernameToBindDnConverter(getAuthenticationProperties().getUsernameToBindDnConverter()</span>
<span class="fc" id="L177">        .apply(getAuthenticationProperties()));</span>

    // accountControlEvaluator
<span class="fc bfc" id="L180" title="All 2 branches covered.">    if (isNull(getAuthenticationProperties().getAccountControlEvaluator())) {</span>
<span class="fc" id="L181">      setAccountControlEvaluator(new NoAccountControlEvaluator());</span>
    } else {
<span class="fc" id="L183">      setAccountControlEvaluator(getAuthenticationProperties().getAccountControlEvaluator().get());</span>
    }
<span class="fc" id="L185">  }</span>

  /**
   * Sets email to username resolver.
   *
   * @param emailToUsernameResolver the email to username resolver
   */
  public void setEmailToUsernameResolver(
      EmailToUsernameResolver emailToUsernameResolver) {
<span class="fc bfc" id="L194" title="All 2 branches covered.">    if (nonNull(emailToUsernameResolver)) {</span>
<span class="fc" id="L195">      this.emailToUsernameResolver = emailToUsernameResolver;</span>
    }
<span class="fc" id="L197">  }</span>

  /**
   * Sets username to bind dn converter.
   *
   * @param usernameToBindDnConverter the username to bind dn converter
   */
  public void setUsernameToBindDnConverter(
      UsernameToBindDnConverter usernameToBindDnConverter) {
<span class="fc bfc" id="L206" title="All 2 branches covered.">    if (nonNull(usernameToBindDnConverter)) {</span>
<span class="fc" id="L207">      this.usernameToBindDnConverter = usernameToBindDnConverter;</span>
    }
<span class="fc" id="L209">  }</span>

  /**
   * Sets account control evaluator.
   *
   * @param accountControlEvaluator the account control evaluator
   */
  public void setAccountControlEvaluator(
      AccountControlEvaluator accountControlEvaluator) {
<span class="fc bfc" id="L218" title="All 2 branches covered.">    if (nonNull(accountControlEvaluator)) {</span>
<span class="fc" id="L219">      this.accountControlEvaluator = accountControlEvaluator;</span>
    }
<span class="fc" id="L221">  }</span>

  /**
   * Init.
   */
  public void init() {
<span class="fc bfc" id="L227" title="All 4 branches covered.">    if (!bindWithAuthentication() &amp;&amp; isNull(getPasswordEncoder())) {</span>
<span class="fc" id="L228">      throw new IllegalStateException(String.format(&quot;A password attribute is set (%s) but no &quot;</span>
              + &quot;password encoder is present. Either delete the password attribute to perform a &quot;
              + &quot;bind to authenticate or set a password encoder.&quot;,
<span class="fc" id="L231">          getAuthenticationProperties().getPasswordAttribute()));</span>
    }
<span class="fc" id="L233">  }</span>

  @Override
  public boolean supports(Class&lt;?&gt; authentication) {
<span class="fc" id="L237">    return UsernamePasswordAuthenticationToken.class.isAssignableFrom(authentication);</span>
  }

  /**
   * Determines whether the given authentication is a remember-me authentication.
   *
   * @param authentication the authentication
   * @return the boolean
   */
  protected boolean isRememberMeAuthenticationToken(Authentication authentication) {
<span class="pc bpc" id="L247" title="1 of 2 branches missed.">    return authentication instanceof RememberMeAuthenticationToken</span>
<span class="fc bfc" id="L248" title="All 2 branches covered.">        &amp;&amp; authentication.getPrincipal() instanceof LdaptiveUserDetails;</span>
  }

  @Override
  public LdaptiveAuthentication authenticate(Authentication authentication)
      throws AuthenticationException {
<span class="fc" id="L254">    logger.debug(&quot;Authenticating user '&quot; + authentication.getName() + &quot;' ...&quot;);</span>
<span class="fc" id="L255">    String username = getEmailToUsernameResolver()</span>
<span class="fc" id="L256">        .getUsernameByEmail(authentication.getName())</span>
<span class="fc" id="L257">        .orElseGet(authentication::getName);</span>
<span class="fc" id="L258">    String password = String.valueOf(authentication.getCredentials());</span>
<span class="fc" id="L259">    LdaptiveTemplate ldaptiveTemplate = getLdapTemplate(username, password);</span>
<span class="fc" id="L260">    LdaptiveUserDetails userDetails = getUserDetails(ldaptiveTemplate, username);</span>
<span class="fc" id="L261">    checkPassword(ldaptiveTemplate, userDetails, password);</span>
<span class="fc" id="L262">    checkAccountControl(userDetails);</span>
<span class="fc bfc" id="L263" title="All 2 branches covered.">    if (nonNull(getTokenConverter())) {</span>
<span class="fc" id="L264">      return getTokenConverter().convert(userDetails);</span>
    }
<span class="fc" id="L266">    return new LdaptiveAuthenticationToken(getAuthenticationProperties(), userDetails);</span>
  }

  /**
   * Determines whether to bind with username and password or with the application ldaptive
   * template.
   *
   * @return the boolean
   */
  protected boolean bindWithAuthentication() {
<span class="fc bfc" id="L276" title="All 2 branches covered.">    return isNull(getAuthenticationProperties().getPasswordAttribute())</span>
<span class="fc bfc" id="L277" title="All 2 branches covered.">        || getAuthenticationProperties().getPasswordAttribute().isBlank();</span>
  }

  /**
   * Gets ldap template.
   *
   * @param username the username
   * @param password the password
   * @return the ldap template
   */
  protected LdaptiveTemplate getLdapTemplate(String username, String password) {
<span class="fc bfc" id="L288" title="All 2 branches covered.">    if (bindWithAuthentication()) {</span>
<span class="fc" id="L289">      ConnectionConfig authConfig = ConnectionConfig</span>
<span class="fc" id="L290">          .copy(getApplicationLdaptiveTemplate().getConnectionFactory().getConnectionConfig());</span>
<span class="fc" id="L291">      String bindDn = getUsernameToBindDnConverter().convert(username);</span>
<span class="fc" id="L292">      authConfig.setConnectionInitializers(BindConnectionInitializer.builder()</span>
<span class="fc" id="L293">          .dn(bindDn)</span>
<span class="fc" id="L294">          .credential(password)</span>
<span class="fc" id="L295">          .build());</span>
<span class="fc" id="L296">      return new LdaptiveTemplate(new DefaultConnectionFactory(authConfig));</span>
    }
<span class="fc" id="L298">    return getApplicationLdaptiveTemplate();</span>
  }

  /**
   * Gets user details.
   *
   * @param ldaptiveTemplate the ldaptive template
   * @param username the username
   * @return the user details
   */
  protected LdaptiveUserDetails getUserDetails(LdaptiveTemplate ldaptiveTemplate, String username) {
    try {
<span class="fc" id="L310">      return getUserDetailsService(ldaptiveTemplate).loadUserByUsername(username);</span>
<span class="fc" id="L311">    } catch (LdaptiveException le) {</span>
<span class="fc" id="L312">      throw getBindException(le);</span>
    }
  }

  /**
   * Gets user details service.
   *
   * @return the user details service
   */
  public LdaptiveUserDetailsService getUserDetailsService() {
<span class="fc" id="L322">    return getUserDetailsService(getApplicationLdaptiveTemplate());</span>
  }

  /**
   * Gets user details service.
   *
   * @param ldaptiveTemplate the ldaptive template
   * @return the user details service
   */
  protected LdaptiveUserDetailsService getUserDetailsService(LdaptiveTemplate ldaptiveTemplate) {
<span class="fc" id="L332">    LdaptiveUserDetailsService userDetailsService = new LdaptiveUserDetailsService(</span>
<span class="fc" id="L333">        getAuthenticationProperties(), ldaptiveTemplate);</span>
<span class="fc" id="L334">    userDetailsService.setAccountControlEvaluator(getAccountControlEvaluator());</span>
<span class="fc" id="L335">    userDetailsService.setGrantedAuthoritiesMapper(getGrantedAuthoritiesMapper());</span>
<span class="fc" id="L336">    userDetailsService.setRememberMeTokenProvider(getPasswordProvider());</span>
<span class="fc" id="L337">    return userDetailsService;</span>
  }

  private RuntimeException getBindException(LdaptiveException exception) {
<span class="fc" id="L341">    BadCredentialsException badCredentials = new BadCredentialsException(&quot;Password doesn't match.&quot;);</span>
<span class="pc bpc" id="L342" title="1 of 2 branches missed.">    if (isInvalidCredentialsException(exception.getLdapException())) {</span>
<span class="fc" id="L343">      return badCredentials;</span>
    }
<span class="nc" id="L345">    return exception;</span>
  }

  private boolean isInvalidCredentialsException(LdapException exception) {
<span class="pc bpc" id="L349" title="1 of 2 branches missed.">    if (Objects.isNull(exception)) {</span>
<span class="nc" id="L350">      return false;</span>
    }
<span class="fc bfc" id="L352" title="All 2 branches covered.">    if (ResultCode.INVALID_CREDENTIALS.equals(exception.getResultCode())) {</span>
<span class="fc" id="L353">      return true;</span>
    }
<span class="fc" id="L355">    String message = Optional.ofNullable(exception.getMessage())</span>
<span class="fc" id="L356">        .map(String::toLowerCase)</span>
<span class="fc" id="L357">        .orElse(&quot;&quot;);</span>
<span class="fc" id="L358">    String text = (&quot;resultCode=&quot; + ResultCode.INVALID_CREDENTIALS).toLowerCase();</span>
<span class="pc bpc" id="L359" title="2 of 4 branches missed.">    if (ResultCode.CONNECT_ERROR.equals(exception.getResultCode()) &amp;&amp; message.contains(text)) {</span>
<span class="fc" id="L360">      return true;</span>
    }
<span class="nc bnc" id="L362" title="All 2 branches missed.">    if (exception.getCause() instanceof LdapException cause) {</span>
<span class="nc" id="L363">      return isInvalidCredentialsException(cause);</span>
    }
<span class="nc" id="L365">    return false;</span>
  }

  /**
   * Check password.
   *
   * @param ldaptiveTemplate the ldaptive template
   * @param user the user
   * @param password the password
   */
  protected void checkPassword(
      LdaptiveTemplate ldaptiveTemplate,
      LdaptiveUserDetails user,
      String password) {

<span class="fc bfc" id="L380" title="All 2 branches covered.">    if (!bindWithAuthentication()) {</span>
<span class="fc" id="L381">      Assert.notNull(getPasswordEncoder(), &quot;No password encoder is present.&quot;);</span>
<span class="fc" id="L382">      boolean matches = ldaptiveTemplate.compare(CompareRequest.builder()</span>
<span class="fc" id="L383">          .dn(user.getDn())</span>
<span class="fc" id="L384">          .name(getAuthenticationProperties().getPasswordAttribute())</span>
<span class="fc" id="L385">          .value(getPasswordEncoder().encode(password))</span>
<span class="fc" id="L386">          .build());</span>
<span class="fc bfc" id="L387" title="All 2 branches covered.">      if (!matches) {</span>
<span class="fc" id="L388">        throw new BadCredentialsException(&quot;Password doesn't match.&quot;);</span>
      }
    }
<span class="fc" id="L391">  }</span>

  /**
   * Check account control.
   *
   * @param user the user
   */
  protected void checkAccountControl(LdaptiveUserDetails user) {
<span class="fc bfc" id="L399" title="All 2 branches covered.">    if (!user.isEnabled()) {</span>
<span class="fc" id="L400">      throw new DisabledException(&quot;Account is disabled.&quot;);</span>
    }
<span class="fc bfc" id="L402" title="All 2 branches covered.">    if (!user.isAccountNonLocked()) {</span>
<span class="fc" id="L403">      throw new LockedException(&quot;Account is locked.&quot;);</span>
    }
<span class="fc bfc" id="L405" title="All 2 branches covered.">    if (!user.isAccountNonExpired()) {</span>
<span class="fc" id="L406">      throw new AccountExpiredException(&quot;Account is expired.&quot;);</span>
    }
<span class="fc bfc" id="L408" title="All 2 branches covered.">    if (!user.isCredentialsNonExpired()) {</span>
<span class="fc" id="L409">      throw new CredentialsExpiredException(&quot;Credentials are expired.&quot;);</span>
    }
<span class="fc" id="L411">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>